# Complexity file

## Gale-Shapley

### Complexité théorique

Nous allons calculer théoriquement la complexité de l'algorithme de Gale-Shapley présent dans le ficher GaleShapley.R.

Tout d'abord, notons les complexité au sein des boucles. Notons $n$ le nombre d'homme (= nombre de femme aussi).

```{r}
gale_shapley <- function(men_prefs, women_prefs) {
  free_men <- names(men_prefs)    #O(1)
  engaged <- list()    #O(1)
  next_proposal <- setNames(rep(1, length(free_men)), free_men)    #O(1)

  # Helper function: rank of a man for a woman
  rank <- lapply(women_prefs, function(prefs) setNames(seq_along(prefs), prefs))    #O(n^2) n vector of size n

  while (length(free_men) > 0) {
    man <- free_men[1]    #O(1)
    woman <- men_prefs[[man]][next_proposal[man]]    #O(1)

    # Man proposes
    if (is.null(engaged[[woman]])) {    #O(1)
      engaged[[woman]] <- man    #O(1)
      free_men <- setdiff(free_men, man)    #O(n) worst case
    } else {    #O(1)
      current <- engaged[[woman]]    #O(1)
      if (rank[[woman]][[man]] < rank[[woman]][[current]]) {    #O(1)
        engaged[[woman]] <- man    #O(1)
        free_men <- c(free_men, current)    #O(1)
        free_men <- setdiff(free_men, man)    #O(n) worst case
      } else {    #O(1)
        # Woman rejects this man
      }
    }

    next_proposal[man] <- next_proposal[man] + 1    #O(1)
  }

  matches <- data.frame(    #O(1)
    Man = unlist(engaged),
    Woman = names(engaged),
    stringsAsFactors = FALSE
  )
  return(matches)    #O(1)
}


```

Concernant la boucle while, chaque homme fait sa demande aux femmes dans l'ordre de ses préférences et il ne peut faire sa demande qu'une seule fois.

Nous avons dans le pire des cas $n$ propositions par homme. Vu qu'il y a $n$ homme, cela ferait $n^2$ demandes. Il faut aussi prendre en compte le fait que setdiff() à une complexité linéaire sur la liste prise en argument. Sauf que dans ce cas de figure précis, la liste que setdiff prend en argument (free_men) se retrouverait quasiment vide presque tout le temps. On peut donc négliger sa complexité.

Ainsi :
$$C(\text{Gale-Shapley})=O(n^2)$$
### Complexité empirique

Voyons comment évolue le temps que met l'algorithme à tourner en fonction de $n$.

```{r}
library(package)

#' Test the runtime of Gale-Shapley
#'
#' @description Runs the algorithm for random preference lists of size n and returns execution time.
#' @param n Number of men/women.
#' @return Execution time in seconds.
#' @export
test_gs_time <- function(n) {
  men <- paste0("M", 1:n)
  women <- paste0("W", 1:n)

  men_prefs <- lapply(1:n, function(i) sample(women))
  names(men_prefs) <- men

  women_prefs <- lapply(1:n, function(i) sample(men))
  names(women_prefs) <- women

  time <- system.time({
    gale_shapley(men_prefs, women_prefs)
  })
  return(time["elapsed"])
}
```

```{r}
library(ggplot2)

# Choose sizes to test
sizes <- seq(100, 5000, by = 500)

# Measure runtime for each size
times <- sapply(sizes, test_gs_time)

# Build data frame for plotting
df <- data.frame(
  n = sizes,
  time = times,
  n_squared = (sizes^2) / max(sizes^2) * max(times) # scaled for comparison
)

# Plot measured time and n^2 curve
ggplot(df, aes(x = n)) +
  geom_line(aes(y = time), size = 1.2, color = 'red') +
  geom_point(aes(y = time), size = 2, color = 'red') +
  geom_line(aes(y = n_squared), linetype = "dashed", size = 1, color = 'red') +
  labs(
    title = "Temporal Complexity of Gale–Shapley (Empirical vs n²)",
    x = "n (number of men/women)",
    y = "Execution time (seconds)"
  ) +
  theme_minimal(base_size = 14)
```
On observe bien un temps d'execution quadratique, car si l'on plot avec une échelle logarithmique on observe bien une droite de pente égale à 2.

```{r}
ggplot(df, aes(x = n)) +
  geom_line(aes(y = time), size = 1.2, color = 'red') +
  geom_point(aes(y = time), size = 2, color = 'red') +
  geom_line(aes(y = n_squared), linetype = "dashed", size = 1, color = 'green') +
  labs(
    title = "Gale–Shapley Complexity (Log–Log Scale)",
    x = "log(n)",
    y = "log(time)"
  ) +
  scale_x_log10() +
  scale_y_log10() +
  theme_minimal(base_size = 14)
```


